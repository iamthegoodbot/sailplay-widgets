var SAILPLAY=function(){function a(){alert("Please init SailPlay HUB first!")}function b(a){function b(a){var b={};if(a.origin==h.DOMAIN)try{b=JSON.parse(a.data)}catch(d){}return"login.success"==b.name?void f.send("login.do",b.auth_hash):"login.cancel"==b.name?(f.send("login.cancel"),void c()):"login.check"==b.name?void("None"==b.auth_hash?f.send("logout"):(c(),f.send("login.do",b.auth_hash))):void("logout.success"==b.name&&(h.auth_hash="",f.send("logout.success")))}function c(){if(d.created)try{document.body.removeChild(d)}catch(a){}}var d;a=a||{},a.node&&1==a.node.nodeType&&"IFRAME"==a.node.tagName?d=a.node:(d=document.createElement("IFRAME"),d.style.border="none",d.style.position="fixed",d.style.top="0",d.style.left="0",d.style.bottom="0",d.style.right="0",d.style.width="410px",d.style.height="510px",d.created=!0,d.style.background="transparent",d.style.margin="auto",d.style.zIndex="100000",document.body.appendChild(d));var e=d.id||"sailplay_login_frame_"+(new Date).getTime();d.name=e,d.id=e;var g={};g.partner_id=h.partner.id,g.dep_id=h.dep_id||"",g.background=a.background||"",g.partner_info=a.partner_info||0;var i=[],k=h.DOMAIN+"/users/auth-page/?";for(var l in g)i.push(l+"="+encodeURIComponent(g[l]));k+=i.join("&"),d.setAttribute("src",k),j||(window.addEventListener("message",b,!1),j=!0)}function c(a){var b={gift_public_key:a.gift_public_key,auth_hash:h.auth_hash};e.get(h.DOMAIN+h.urls.gifts.purchase.force_confirm,b,function(a){"ok"==a.status?f.send("gift.purchase.force_complete.success",a):f.send("gift.purchase.force_complete.error",a)})}Array.prototype.indexOf||(Array.prototype.indexOf=function(a){var b=this.length>>>0,c=Number(arguments[1])||0;for(c=0>c?Math.ceil(c):Math.floor(c),0>c&&(c+=b);b>c;c++)if(c in this&&this[c]===a)return c;return-1});var d={createCookie:function(a,b,c){if(c){var d=new Date;d.setTime(d.getTime()+24*c*60*60*1e3);var e="; expires="+d.toGMTString()}else var e="";document.cookie=a+"="+b+e+"; path=/"},readCookie:function(a){for(var b=a+"=",c=document.cookie.split(";"),d=0;d<c.length;d++){for(var e=c[d];" "==e.charAt(0);)e=e.substring(1,e.length);if(0==e.indexOf(b))return e.substring(b.length,e.length)}return null},eraseCookie:function(a){d.createCookie(a,"",-1)}},e={currentScript:null,get:function(a,b,c,d){var e=a+(a.indexOf("?")+1?"&":"?"),f=document.getElementsByTagName("head")[0],g=document.createElement("script"),i=[];b=b||{},h.auth_hash||delete b.auth_hash,window.JSONP_CALLBACK=window.JSONP_CALLBACK||{};var j="sailplay_"+(new Date).getTime()+Math.random().toString().replace(".",""),k=setTimeout(function(){try{f.removeChild(g)}catch(a){}delete window.JSONP_CALLBACK[j]},1e4);window.JSONP_CALLBACK[j]=function(a){clearTimeout(k);try{f.removeChild(g)}catch(b){}delete window.JSONP_CALLBACK[j],c&&c(a)},b.callback="JSONP_CALLBACK."+j,h.dep_id&&(b.dep_id=h.dep_id);for(var l in b)i.push(l+"="+encodeURIComponent(b[l]));e+=i.join("&"),g.type="text/javascript",g.src=e,g.onerror=function(a){try{f.removeChild(g)}catch(b){}delete window.JSONP_CALLBACK[j],d&&d(a)},f.insertBefore(g,f.firstChild)},success:null},f={},g={};f.on=function(a,b){"undefined"==typeof g[a]&&(g[a]=[]),g[a].push(b)},f.send=function(a,b){if(g[a])for(var c=0;c<g[a].length;c++)g[a][c](b)};var h={},i={},j=!1;f.on("init",function(a){return a||alert("SailPlay: provide required parameters"),a.partner_id?void e.get((a.domain||"http://sailplay.ru")+"/js-api/"+a.partner_id+"/config/",{lang:a.lang||"ru",dep_id:a.dep_id||""},function(b){function c(a){var b={};if(a.origin==h.DOMAIN){try{b=JSON.parse(a.data)}catch(c){}switch(b&&b.name){case"actions.perform.success":f.send("actions.perform.success",b);break;case"actions.perform.error":f.send("actions.perform.error",b);break;case"actions.social.connect.complete":f.send("actions.social.connect.complete",b);break;case"actions.social.connect.success":f.send("actions.social.connect.success",b);break;case"actions.social.connect.error":f.send("actions.social.connect.error",b);break;case"friend_invite_cookie":}}}b&&"ok"==b.status?(h=b.config,h.DOMAIN=a.domain||"http://sailplay.ru",h.dep_id=a.dep_id||"",h.env.staticUrl=a.static_url||h.env.staticUrl,h.social_networks=["fb","vk","tw","gp","ok"],h.platform=a.platform||"desktop",window.addEventListener("message",c,!1),h.ref_hash=f.url_params().ref_hash||"",f.send("init.success",h)):(f.send("init.error",b),alert("SailPlay: app load failed!"))}):void alert("SailPlay: provide partner_id")}),f.on("login.remote",function(a){b(a)}),f.on("language.set",function(b){return h=={}?void a():void("string"==typeof b&&e.get(h.DOMAIN+"/js-api/"+h.partner.id+"/config/",{lang:b},function(a){a&&"ok"==a.status?(h.lang=a.config.lang,f.send("language.set.success",h.lang)):f.send("language.set.error",a)}))}),f.on("login.do",function(a){h.auth_hash=a;var b={auth_hash:h.auth_hash};e.get(h.DOMAIN+h.urls.users.info,b,function(a){"ok"==a.status?f.send("login.success",a.user):(h.auth_hash="",f.send("login.error",a))})}),f.on("login",function(b){return h=={}?void a():void f.send("login.do",b)}),f.on("logout",function(){if(h=={})return void a();var b=document.createElement("iframe");b.width=0,b.height=0,b.style.border="none",b.src=h.DOMAIN+"/users/logout",document.body.appendChild(b),b.onload=function(){document.body.removeChild(b)},h.auth_hash="",d.eraseCookie("sp_auth_hash"),f.send("logout.success")}),f.on("load.user.info",function(){if(h=={})return void a();var b={auth_hash:h.auth_hash,user_status:1,badges:1,last_badge:1,ref_hash:h.ref_hash};e.get(h.DOMAIN+h.urls.users.info,b,function(a){"ok"==a.status?f.send("load.user.info.success",a):f.send("load.user.info.error",a)})}),f.on("load.user.history",function(){if(h=={})return void a();var b={auth_hash:h.auth_hash};e.get(h.DOMAIN+h.urls.users.history,b,function(a){"ok"==a.status?f.send("load.user.history.success",a.history):f.send("load.user.history.error",a)})}),f.on("gifts.get",function(b){if(h=={})return void a();var c={gift_id:b,auth_hash:h.auth_hash};e.get(h.DOMAIN+h.urls.gifts.get,c,function(a){"ok"==a.status?f.send("gifts.get.success",a.gift):f.send("gifts.get.error",a)})}),f.on("load.gifts.list",function(){if(h=={})return void a();var b={auth_hash:h.auth_hash};e.get(h.DOMAIN+h.urls.gifts.list,b,function(a){"ok"==a.status?f.send("load.gifts.list.success",a.gifts):f.send("load.gifts.list.error",a)})}),f.on("gifts.purchase",function(b){if(h=={})return void a();if(h.auth_hash){var d={gift_id:b.id,dep_id:h.dep_id||h.partner.depId||"",auth_hash:h.auth_hash};e.get(h.DOMAIN+h.urls.gifts.purchase.purchase,d,function(a){if("ok"==a.status){if(f.send("gifts.purchase.success",a),a.is_completed){var b=a;if(b.request_to_partner_url){var d={gift_public_key:b.gift_public_key,gift_sku:b.gift_sku,auth_hash:h.auth_hash};b.user_phone&&(d.user_phone=b.user_phone),b.email&&(d.email=b.email),e.get(b.request_to_partner_url,d,function(a){f.send("gifts.purchase.partner_request.success",a)},function(a){f.send("gifts.purchase.partner_request.error",a),c(b)})}else c(b)}}else f.send("gift.purchase.error",a)})}else f.send("gifts.purchase.auth.error",b)}),f.on("load.badges.list",function(){if(h=={})return void a();var b={auth_hash:h.auth_hash};e.get(h.DOMAIN+h.urls.badges.list,b,function(a){function b(a){if(a&&a.is_received){a.actions={};for(var b in h.social_networks)a.actions[h.social_networks[b]]={socialType:h.social_networks[b],action:"badge",shortLink:window.location.href,pic:a.thumbs.url_250x250,badgeId:a.id,msg:a.share_msg}}}if("ok"==a.status){for(var c in a.multilevel_badges){var d=a.multilevel_badges[c];for(var e in d)b(d[e])}for(var g in a.one_level_badges)b(a.one_level_badges[g]);f.send("load.badges.list.success",a)}else f.send("load.badges.list.error",a)})}),f.on("load.actions.list",function(){if(h=={})return void a();var b={auth_hash:h.auth_hash};e.get(h.DOMAIN+h.urls.actions.load,b,function(a){"ok"==a.status?(i=a.data,f.send("load.actions.list.success",a.data)):f.send("load.actions.list.error",a)})}),f.actions={},f.actions.parse=function(a,b){function c(a){var b=[];for(var c in a)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")}if(!f.is_dom(a))return void console.error("sp.actions.parse() need DOM element as first parameter");if(!b)return void console.error("sp.actions.parse() need Action object as second parameter");if(!i.connectedAccounts)return void console.error("sp.actions.parse() must execute after event load.actions.list.success");if("cordova"===h.platform||!b.socialType)return console.dir(b),void a.addEventListener("click",function(){f.send("actions.perform",b)});var d=a.getAttribute("data-styles"),e=document.createElement("IFRAME");e.style.border="none",e.style.width="150px",e.style.height="30px",e.style.background="transparent",e.style.overflow="hidden",e.setAttribute("scrolling","no"),e.className="sailplay_action_frame";var g={auth_hash:h.auth_hash,socialType:b.socialType,action:b.action,link:b.shortLink,pic:b.pic||i.partnerCustomPic||h.partner.logo,msg:b.msg||i.messages[b.action]||h.partner.name,account_connected:i.connectedAccounts[b.socialType]||!1};b._actionId&&(g._actionId=b._actionId),d&&(g.styles=d),"purchase"==b.action&&(g.purchasePublicKey=i.purchasePublicKey),"badge"==b.action&&(g.badgeId=b.badgeId),e.src=h.DOMAIN+"/js-api/"+h.partner.id+"/actions/social-widget/v2/?"+c(g),a.innerHTML="",a.appendChild(e)},f.on("actions.parse",function(b){return h=={}?void a():void(b&&Array.isArray(b)?k.social_init(b):f.send("actions.parse.error",{message:"Actions list needed"}))});var k={};return k.social_init=function(a){for(var b=document.querySelectorAll("[data-sp-action]"),c=0;c<b.length;c+=1)!function(){var d=b[c],e=Number(d.getAttribute("data-sp-action")),g=f.find_by_properties(a||i.actions,{_actionId:e})[0];f.actions.parse(d,g)}()},k.openSocialRegNeedPopup=function(a){var b;b="vk"==a.socialType?k.popupWindow(i.social.vk.authUrl,"social_reg",840,400):k.popupWindow(i.social[a.socialType].authUrl,"social_reg");var c=setInterval(function(){(null==b||b.closed)&&(f.send("actions.social.connect.complete"),clearInterval(c))},100);b.addEventListener("loadstop",function(a){0==a.url.indexOf(h.DOMAIN)&&(b.close(),f.send("actions.social.connect.complete"),clearInterval(c))})},k.popupWindow=function(a,b,c,d){var e,f,g,h;return void 0!==c&&void 0!==d?(e=c,f=d,g=screen.width/2-c/2,h=screen.height/2-d/2):(e=screen.width/2,f=screen.height/2,g=e-e/2,h=f-f/2),window.open(a,b,"toolbar=no, location=no, directories=no, status=no, menubar=no, copyhistory=no, width="+e+", height="+f+", top="+h+", left="+g)},k.share=function(a){var b=h.DOMAIN+"/js-api/"+h.partner.id+"/actions/social-widget/?auth_hash="+h.auth_hash;b+="&socialType="+a.socialType+"&action="+a.action+"&link="+a.shortLink+"&pic="+(i.partnerCustomPic?i.partnerCustomPic:h.partner.logo),b+="&msg="+i.messages[a.action],b+="&_actionId="+a._actionId,"purchase"==a.action&&(b+="&purchasePublicKey="+i.purchasePublicKey);var c=k.popupWindow(b,"social_action",200,210),d=setInterval(function(){(null==c||c.closed)&&(f.send("actions.perform.complete",a),clearInterval(d))},200)},k.perform=function(a){var b=h.DOMAIN+"/popup/"+h.partner.id+"/widgets/custom/"+a.type+"/?auth_hash="+h.auth_hash;b+="&lang="+h.lang,b+="&from_sdk=0";var c=k.popupWindow(b,"SailPlay",600,400),d=setInterval(function(){(null==c||c.closed)&&(f.send("actions.perform.complete",a),clearInterval(d))},200)},f.on("actions.perform",function(b){return h=={}?void a():void(h.auth_hash?(f.send("actions.perform.start",b),b.socialType&&i.connectedAccounts?i.connectedAccounts[b.socialType]?k.share(b):k.openSocialRegNeedPopup(b):b.socialType||k.perform(b)):f.send("actions.perform.auth.error",b))}),f.on("promocodes.apply",function(b){return h=={}?void a():(b.auth_hash=h.auth_hash,void(h.auth_hash?e.get(h.DOMAIN+h.urls.promocodes.apply,b,function(a){"ok"==a.status?f.send("promocodes.apply.success",a):f.send("promocodes.apply.error",a)}):f.send("promocodes.apply.auth.error",action)))}),f.on("tags.add",function(b){if(h=={})return void a();if(h.auth_hash){var c={tags:b.join(","),auth_hash:h.auth_hash};e.get(h.DOMAIN+h.urls.tags.add,c,function(a){"ok"==a.status?f.send("tags.add.success",a):f.send("tags.add.error",a)})}else SAILPLAY.trigger("tags.add.auth.error",b)}),f.on("leaderboard.load",function(){if(h=={})return void a();var b={auth_hash:h.auth_hash};e.get(h.DOMAIN+h.urls.leaderboard.data,b,function(a){"ok"==a.status?f.send("leaderboard.load.success",a.data):f.send("leaderboard.load.error",a)})}),f.on("load.reviews.list",function(b){if(h=={})return void a();var c={};b&&(c.page=b.page||1),e.get(h.DOMAIN+h.urls.reviews.list,c,function(a){"ok"==a.status?f.send("load.reviews.list.success",{page:a.page,pages:a.pages,reviews:a.reviews}):f.send("load.reviews.list.error",a)})}),f.on("reviews.add",function(b){if(h=={})return void a();var c={auth_hash:h.auth_hash,rating:b.rating||"",review:b.review||""};e.get(h.DOMAIN+h.urls.reviews.add,c,function(a){"ok"==a.status?f.send("reviews.add.success",a):f.send("reviews.add.error",a)})}),f.on("purchases.add",function(b){if(h=={})return void a();var c={auth_hash:h.auth_hash,price:b.price||"",order_num:b.order_num||""};e.get(h.DOMAIN+h.urls.purchase,c,function(a){"ok"==a.status?f.send("purchases.add.success",a):f.send("purchases.add.error",a)})}),f.config=function(){return h},f.find_by_properties=function(a,b){for(var c=[],d=0;d<a.length;d+=1){var e=a[d],f=!0;for(var g in b)b[g]!=e[g]&&(f=!1);f&&c.push(e)}return c},f.jsonp=e,f.is_dom=function(a){function b(a){return"object"==typeof Node?a instanceof Node:a&&"object"==typeof a&&"number"==typeof a.nodeType&&"string"==typeof a.nodeName}function c(a){return"object"==typeof HTMLElement?a instanceof HTMLElement:a&&"object"==typeof a&&null!==a&&1===a.nodeType&&"string"==typeof a.nodeName}return b(a)||c(a)},f.url_params=function(){for(var a={},b=window.location.search.substring(1),c=b.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");"undefined"==typeof a[e[0]]?a[e[0]]=decodeURIComponent(e[1]):"string"==typeof a[e[0]]?a[e[0]]=[a[e[0]],decodeURIComponent(e[1])]:a[e[0]].push(decodeURIComponent(e[1]))}return a},f}();